<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Quality mosaicking | Google Earth Engine workshop</title>
  <meta name="description" content="Manual and code for Philip’s Google Earth Engine workshop" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Quality mosaicking | Google Earth Engine workshop" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://kraaijenbrink.github.io/earthengine-workshop" />
  
  <meta property="og:description" content="Manual and code for Philip’s Google Earth Engine workshop" />
  <meta name="github-repo" content="kraaijenbrink/earthengine-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Quality mosaicking | Google Earth Engine workshop" />
  
  <meta name="twitter:description" content="Manual and code for Philip’s Google Earth Engine workshop" />
  

<meta name="author" content="Philip Kraaijenbrink" />


<meta name="date" content="2020-10-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="image-classification.html"/>
<link rel="next" href="regression.html"/>
<script src="libs/header-attrs-2.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#earth-engine-access"><i class="fa fa-check"></i>Earth Engine access</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#earth-engine-help"><i class="fa fa-check"></i>Earth Engine help</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#workshop-code"><i class="fa fa-check"></i>Workshop code</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#source"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="image-classification.html"><a href="image-classification.html"><i class="fa fa-check"></i><b>1</b> Image classification</a>
<ul>
<li class="chapter" data-level="1.1" data-path="image-classification.html"><a href="image-classification.html#define-input-data"><i class="fa fa-check"></i><b>1.1</b> Define input data</a></li>
<li class="chapter" data-level="1.2" data-path="image-classification.html"><a href="image-classification.html#obtain-training-data"><i class="fa fa-check"></i><b>1.2</b> Obtain training data</a></li>
<li class="chapter" data-level="1.3" data-path="image-classification.html"><a href="image-classification.html#classify-image"><i class="fa fa-check"></i><b>1.3</b> Classify image</a></li>
<li class="chapter" data-level="1.4" data-path="image-classification.html"><a href="image-classification.html#visualize-using-charts"><i class="fa fa-check"></i><b>1.4</b> Visualize using charts</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="quality-mosaicking.html"><a href="quality-mosaicking.html"><i class="fa fa-check"></i><b>2</b> Quality mosaicking</a>
<ul>
<li class="chapter" data-level="2.1" data-path="quality-mosaicking.html"><a href="quality-mosaicking.html#define-input-data-1"><i class="fa fa-check"></i><b>2.1</b> Define input data</a></li>
<li class="chapter" data-level="2.2" data-path="quality-mosaicking.html"><a href="quality-mosaicking.html#mask-clouds-and-calculate-index"><i class="fa fa-check"></i><b>2.2</b> Mask clouds and calculate index</a></li>
<li class="chapter" data-level="2.3" data-path="quality-mosaicking.html"><a href="quality-mosaicking.html#quality-mosaic-composite"><i class="fa fa-check"></i><b>2.3</b> Quality mosaic composite</a></li>
<li class="chapter" data-level="2.4" data-path="quality-mosaicking.html"><a href="quality-mosaicking.html#classify-water"><i class="fa fa-check"></i><b>2.4</b> Classify water</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="regression.html"><a href="regression.html"><i class="fa fa-check"></i><b>3</b> Regression</a>
<ul>
<li class="chapter" data-level="3.1" data-path="regression.html"><a href="regression.html#settings-and-data"><i class="fa fa-check"></i><b>3.1</b> Settings and data</a></li>
<li class="chapter" data-level="3.2" data-path="regression.html"><a href="regression.html#derive-annual-composites"><i class="fa fa-check"></i><b>3.2</b> Derive annual composites</a></li>
<li class="chapter" data-level="3.3" data-path="regression.html"><a href="regression.html#calculate-temporal-trend"><i class="fa fa-check"></i><b>3.3</b> Calculate temporal trend</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="climate-data-analysis.html"><a href="climate-data-analysis.html"><i class="fa fa-check"></i><b>4</b> Climate data analysis</a>
<ul>
<li class="chapter" data-level="4.1" data-path="climate-data-analysis.html"><a href="climate-data-analysis.html#define-input-data-2"><i class="fa fa-check"></i><b>4.1</b> Define input data</a></li>
<li class="chapter" data-level="4.2" data-path="climate-data-analysis.html"><a href="climate-data-analysis.html#estimate-mean-temperature"><i class="fa fa-check"></i><b>4.2</b> Estimate mean temperature</a></li>
<li class="chapter" data-level="4.3" data-path="climate-data-analysis.html"><a href="climate-data-analysis.html#determine-relative-change"><i class="fa fa-check"></i><b>4.3</b> Determine relative change</a></li>
<li class="chapter" data-level="4.4" data-path="climate-data-analysis.html"><a href="climate-data-analysis.html#make-charts"><i class="fa fa-check"></i><b>4.4</b> Make charts</a></li>
<li class="chapter" data-level="4.5" data-path="climate-data-analysis.html"><a href="climate-data-analysis.html#end-of-century-climatology"><i class="fa fa-check"></i><b>4.5</b> End of century climatology</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="additional-cases.html"><a href="additional-cases.html"><i class="fa fa-check"></i>Additional cases</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Google Earth Engine workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="quality-mosaicking" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Quality mosaicking</h1>
<p><img src="figures/banner_2.jpg" /></p>
<p><strong>Use a quality mosaicking approach to get both a low tide and high tide image composite, and classify water using simple thresholding on water index to generate a map showing intertidal area.</strong></p>
<div id="define-input-data-1" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Define input data</h2>
<p>First we need to define the datasets that we will use. In this exercise you will use Landsat 8 <a href="http://gsp.humboldt.edu/olm_2015/Courses/GSP_216_Online/lesson4-1/radiometric.html">top of atmosphere reflectance</a> data. Copy and paste the lines below to a blank script:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb12-1"><a href="quality-mosaicking.html#cb12-1"></a><span class="co">// Settings ======================================</span></span>
<span id="cb12-2"><a href="quality-mosaicking.html#cb12-2"></a><span class="kw">var</span> cloudcov <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb12-3"><a href="quality-mosaicking.html#cb12-3"></a><span class="kw">var</span> imageQ   <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb12-4"><a href="quality-mosaicking.html#cb12-4"></a> </span>
<span id="cb12-5"><a href="quality-mosaicking.html#cb12-5"></a><span class="co">// get data</span></span>
<span id="cb12-6"><a href="quality-mosaicking.html#cb12-6"></a><span class="kw">var</span> ls8rfl <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;LANDSAT/LC08/C01/T1_TOA&quot;</span>)<span class="op">;</span> </span>
<span id="cb12-7"><a href="quality-mosaicking.html#cb12-7"></a><span class="kw">var</span> westerschelde <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>(<span class="fl">3.83</span><span class="op">,</span><span class="fl">51.42</span>)<span class="op">;</span></span>
<span id="cb12-8"><a href="quality-mosaicking.html#cb12-8"></a> </span>
<span id="cb12-9"><a href="quality-mosaicking.html#cb12-9"></a><span class="co">// filter the landsat 8 collection and rename bands</span></span>
<span id="cb12-10"><a href="quality-mosaicking.html#cb12-10"></a><span class="kw">var</span> ls8rfl <span class="op">=</span> ls8rfl</span>
<span id="cb12-11"><a href="quality-mosaicking.html#cb12-11"></a>        <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lte</span>(<span class="st">&#39;CLOUD_COVER&#39;</span><span class="op">,</span>cloudcov))</span>
<span id="cb12-12"><a href="quality-mosaicking.html#cb12-12"></a>        <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;IMAGE_QUALITY_OLI&#39;</span><span class="op">,</span>imageQ))  </span>
<span id="cb12-13"><a href="quality-mosaicking.html#cb12-13"></a>        <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(x){</span>
<span id="cb12-14"><a href="quality-mosaicking.html#cb12-14"></a>        <span class="cf">return</span> x<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;B2&#39;</span><span class="op">,</span><span class="st">&#39;B3&#39;</span><span class="op">,</span><span class="st">&#39;B4&#39;</span><span class="op">,</span><span class="st">&#39;B5&#39;</span><span class="op">,</span><span class="st">&#39;B6&#39;</span><span class="op">,</span><span class="st">&#39;B10&#39;</span><span class="op">,</span><span class="st">&#39;B7&#39;</span><span class="op">,</span><span class="st">&#39;BQA&#39;</span>])</span>
<span id="cb12-15"><a href="quality-mosaicking.html#cb12-15"></a>                <span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;tir&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span><span class="op">,</span> <span class="st">&#39;bqa&#39;</span>])</span>
<span id="cb12-16"><a href="quality-mosaicking.html#cb12-16"></a>      })<span class="op">;</span></span></code></pre></div>
</div>
<div id="mask-clouds-and-calculate-index" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Mask clouds and calculate index</h2>
<p>Often satellite imagery comes with metadata on the quality of the acquired imagery. This can be overall quality indication, such as used above, but also a quality image band, which holds predetermined information on quality of each pixel in the image. Using the cloud and cloud shadow flags in this band, the cloud pixels can be masked for each image in a loop over the image collection.</p>
<p>Because you will need a water index per image in the analysis later on, it is calculated directly in the same loop. The water index that is calculated here is the Normalized Difference Water Index (<a href="https://www.sentinel-hub.com/eoproducts/ndwi-normalized-difference-water-index">NDWI</a>), which ranges from -1 (no water) to 1 (water).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb13-1"><a href="quality-mosaicking.html#cb13-1"></a><span class="co">// apply cloud mask on per-image basis and add Normalized Difference Water Index band</span></span>
<span id="cb13-2"><a href="quality-mosaicking.html#cb13-2"></a><span class="kw">var</span> util <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/philipkraaijenbrink/tools:utilities&#39;</span>) <span class="co">// load philip&#39;s util functions</span></span>
<span id="cb13-3"><a href="quality-mosaicking.html#cb13-3"></a><span class="kw">var</span> lsmasked <span class="op">=</span> ls8rfl<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(x){           <span class="co">// loop over image collection</span></span>
<span id="cb13-4"><a href="quality-mosaicking.html#cb13-4"></a>  <span class="kw">var</span> cldmask <span class="op">=</span> util<span class="op">.</span><span class="fu">getQAFlags</span>(x<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;bqa&#39;</span>)<span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="st">&#39;clouds&#39;</span>) <span class="co">// get cloud mask from QA band</span></span>
<span id="cb13-5"><a href="quality-mosaicking.html#cb13-5"></a>  <span class="kw">var</span> shdmask <span class="op">=</span> util<span class="op">.</span><span class="fu">getQAFlags</span>(x<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;bqa&#39;</span>)<span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="st">&#39;shadow&#39;</span>) <span class="co">// get cloud shadow mask</span></span>
<span id="cb13-6"><a href="quality-mosaicking.html#cb13-6"></a>  <span class="kw">var</span> masked  <span class="op">=</span> x<span class="op">.</span><span class="fu">updateMask</span>(cldmask<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))                   <span class="co">// apply both masks to the image</span></span>
<span id="cb13-7"><a href="quality-mosaicking.html#cb13-7"></a>                <span class="op">.</span><span class="fu">updateMask</span>(shdmask<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>))</span>
<span id="cb13-8"><a href="quality-mosaicking.html#cb13-8"></a>  <span class="kw">var</span> index   <span class="op">=</span> x<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;nir&#39;</span>])      <span class="co">// calculate NDWI</span></span>
<span id="cb13-9"><a href="quality-mosaicking.html#cb13-9"></a>                <span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;index&#39;</span>)</span>
<span id="cb13-10"><a href="quality-mosaicking.html#cb13-10"></a>  <span class="kw">var</span> invindex <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(index) <span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;invindex&#39;</span>)<span class="co">// get inverted index </span></span>
<span id="cb13-11"><a href="quality-mosaicking.html#cb13-11"></a>  <span class="cf">return</span> masked<span class="op">.</span><span class="fu">addBands</span>(index)<span class="op">.</span><span class="fu">addBands</span>(invindex)   <span class="co">// return masked image incl. index bands</span></span>
<span id="cb13-12"><a href="quality-mosaicking.html#cb13-12"></a>})</span></code></pre></div>
</div>
<div id="quality-mosaic-composite" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Quality mosaic composite</h2>
<p>Using the cloud masked imagery, you can now reduce the image collection to two image composites by sorting, on a pixel level, the Landsat images in the collection using the calculated NDWI values. This is performed using <code>qualityMosaic()</code> (see <a href="https://developers.google.com/earth-engine/ic_composite_mosaic">doc</a>), which determines for each pixel in the composite image the image in the collection that has the maximum pixel value for the band specified.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb14-1"><a href="quality-mosaicking.html#cb14-1"></a><span class="co">// for each spatial pixel select the image that has the lowest/highest NDWI value</span></span>
<span id="cb14-2"><a href="quality-mosaicking.html#cb14-2"></a><span class="co">// in the entire (filtered) LS8 image collection</span></span>
<span id="cb14-3"><a href="quality-mosaicking.html#cb14-3"></a><span class="kw">var</span> minwat  <span class="op">=</span> lsmasked<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;invindex&#39;</span>)<span class="op">;</span></span>
<span id="cb14-4"><a href="quality-mosaicking.html#cb14-4"></a><span class="kw">var</span> maxwat  <span class="op">=</span> lsmasked<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;index&#39;</span>)<span class="op">;</span></span>
<span id="cb14-5"><a href="quality-mosaicking.html#cb14-5"></a><span class="kw">var</span> meanwat <span class="op">=</span> lsmasked<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span></code></pre></div>
<p> </p>
<p>Add the data to the map and inspect the results:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb15-1"><a href="quality-mosaicking.html#cb15-1"></a><span class="co">// add data to map</span></span>
<span id="cb15-2"><a href="quality-mosaicking.html#cb15-2"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(westerschelde<span class="op">,</span> <span class="dv">11</span>)<span class="op">;</span></span>
<span id="cb15-3"><a href="quality-mosaicking.html#cb15-3"></a><span class="kw">var</span> vis_params <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span>[<span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span>]}<span class="op">;</span></span>
<span id="cb15-4"><a href="quality-mosaicking.html#cb15-4"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(minwat<span class="op">,</span>  vis_params<span class="op">,</span> <span class="st">&#39;LT composite&#39;</span><span class="op">,</span>   <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb15-5"><a href="quality-mosaicking.html#cb15-5"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(maxwat<span class="op">,</span>  vis_params<span class="op">,</span> <span class="st">&#39;HT composite&#39;</span><span class="op">,</span>   <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb15-6"><a href="quality-mosaicking.html#cb15-6"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(meanwat<span class="op">,</span> vis_params<span class="op">,</span> <span class="st">&#39;Mean composite&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="classify-water" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Classify water</h2>
<p>Classification of water areas can be performed by applying a threshold on the NDWI values of the image composite. Here, classify the pixels as water when <span class="math inline">\(\rm{NDWI}&gt;=0.2\)</span>. This will create a boolean land-use map with two classes: water = 1, land = 0.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb16-1"><a href="quality-mosaicking.html#cb16-1"></a><span class="co">// classify water on both images using NDWI threshold</span></span>
<span id="cb16-2"><a href="quality-mosaicking.html#cb16-2"></a><span class="kw">var</span> lotide <span class="op">=</span> minwat<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;index&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb16-3"><a href="quality-mosaicking.html#cb16-3"></a><span class="kw">var</span> hitide <span class="op">=</span> maxwat<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;index&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb16-4"><a href="quality-mosaicking.html#cb16-4"></a> </span>
<span id="cb16-5"><a href="quality-mosaicking.html#cb16-5"></a><span class="co">// inspect classifications</span></span>
<span id="cb16-6"><a href="quality-mosaicking.html#cb16-6"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lotide<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;darkgreen&#39;</span><span class="op">,</span><span class="st">&#39;lightblue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Low tide&#39;</span><span class="op">,</span><span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb16-7"><a href="quality-mosaicking.html#cb16-7"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(hitide<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;darkgreen&#39;</span><span class="op">,</span><span class="st">&#39;lightblue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;High tide&#39;</span><span class="op">,</span><span class="kw">true</span>)<span class="op">;</span></span></code></pre></div>
<p> </p>
<p>Are you satisfied with the classification results?</p>
<p>A better classification can probably be achieved by not selecting the extreme values of the NDWI to generate the image composite (<code>qualityMosaic()</code> function). To do so, a custom index must be constructed than can be passed to <code>qualityMosaic()</code>, for instance one based on percentiles of NDWI.</p>
<p>The function below calculates a low and high NDWI percentile at each pixel based on all images in the filtered image collection. It then determines the difference between the NDWI of each image, at each pixel, with those percentile values. To get the index than can be passed to <code>qualityMosaic()</code>, one takes the absolute of the differences and inverts it, so that the smallest difference becomes the largest value.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb17-1"><a href="quality-mosaicking.html#cb17-1"></a><span class="co">// Quite some noise in both classifications because qualitymosaicking picks up the extremes</span></span>
<span id="cb17-2"><a href="quality-mosaicking.html#cb17-2"></a><span class="co">// Try to improve by using percentiles instead. Percentiles determined by trial and error</span></span>
<span id="cb17-3"><a href="quality-mosaicking.html#cb17-3"></a></span>
<span id="cb17-4"><a href="quality-mosaicking.html#cb17-4"></a><span class="co">// get image with low and high percentile NDWI</span></span>
<span id="cb17-5"><a href="quality-mosaicking.html#cb17-5"></a><span class="kw">var</span> indexperc <span class="op">=</span> lsmasked<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;index&#39;</span>])<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">percentile</span>([<span class="dv">16</span><span class="op">,</span><span class="dv">99</span>]<span class="op">,</span> [<span class="st">&#39;lo&#39;</span><span class="op">,</span><span class="st">&#39;hi&#39;</span>]))<span class="op">;</span></span>
<span id="cb17-6"><a href="quality-mosaicking.html#cb17-6"></a></span>
<span id="cb17-7"><a href="quality-mosaicking.html#cb17-7"></a><span class="co">// loop over image collection</span></span>
<span id="cb17-8"><a href="quality-mosaicking.html#cb17-8"></a><span class="kw">var</span> lsmasked  <span class="op">=</span> lsmasked<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(x){             </span>
<span id="cb17-9"><a href="quality-mosaicking.html#cb17-9"></a>  <span class="co">// get absolute difference of the percentiles with the NDWI</span></span>
<span id="cb17-10"><a href="quality-mosaicking.html#cb17-10"></a>  <span class="kw">var</span> selector <span class="op">=</span> x<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;index&#39;</span>)<span class="op">.</span><span class="fu">subtract</span>(indexperc)<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb17-11"><a href="quality-mosaicking.html#cb17-11"></a>  <span class="co">// invert to let the min diff be the largest value</span></span>
<span id="cb17-12"><a href="quality-mosaicking.html#cb17-12"></a>  <span class="kw">var</span> invsel   <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(selector)<span class="op">;</span></span>
<span id="cb17-13"><a href="quality-mosaicking.html#cb17-13"></a>  <span class="co">// add inverted difference band to the image and name properly</span></span>
<span id="cb17-14"><a href="quality-mosaicking.html#cb17-14"></a>  <span class="cf">return</span> x<span class="op">.</span><span class="fu">addBands</span>(invsel<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;selector_lo&#39;</span><span class="op">,</span><span class="st">&#39;selector_hi&#39;</span>]))   </span>
<span id="cb17-15"><a href="quality-mosaicking.html#cb17-15"></a>})<span class="op">;</span></span>
<span id="cb17-16"><a href="quality-mosaicking.html#cb17-16"></a></span>
<span id="cb17-17"><a href="quality-mosaicking.html#cb17-17"></a><span class="co">// use the new selectors to perform the quality mosaic and add to map</span></span>
<span id="cb17-18"><a href="quality-mosaicking.html#cb17-18"></a><span class="kw">var</span> minwat2  <span class="op">=</span> lsmasked<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;selector_lo&#39;</span>)<span class="op">;</span></span>
<span id="cb17-19"><a href="quality-mosaicking.html#cb17-19"></a><span class="kw">var</span> maxwat2  <span class="op">=</span> lsmasked<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;selector_hi&#39;</span>)<span class="op">;</span></span>
<span id="cb17-20"><a href="quality-mosaicking.html#cb17-20"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(minwat2<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span>[<span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;LT composite v2&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb17-21"><a href="quality-mosaicking.html#cb17-21"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(maxwat2<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span>[<span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;HT composite v2&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span></code></pre></div>
<p> </p>
<p>Have a look at the new image composites. This looks much better! They will probably also help to clean up the classification:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="quality-mosaicking.html#cb18-1"></a><span class="co">// classify water on both images using NDWI threshold</span></span>
<span id="cb18-2"><a href="quality-mosaicking.html#cb18-2"></a><span class="kw">var</span> lotide2 <span class="op">=</span> minwat2<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;index&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb18-3"><a href="quality-mosaicking.html#cb18-3"></a><span class="kw">var</span> hitide2 <span class="op">=</span> maxwat2<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;index&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb18-4"><a href="quality-mosaicking.html#cb18-4"></a> </span>
<span id="cb18-5"><a href="quality-mosaicking.html#cb18-5"></a><span class="co">// inspect classifications</span></span>
<span id="cb18-6"><a href="quality-mosaicking.html#cb18-6"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lotide2<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;darkgreen&#39;</span><span class="op">,</span><span class="st">&#39;lightblue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Low tide 2&#39;</span><span class="op">,</span><span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb18-7"><a href="quality-mosaicking.html#cb18-7"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(hitide2<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;darkgreen&#39;</span><span class="op">,</span><span class="st">&#39;lightblue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;High tide 2&#39;</span><span class="op">,</span><span class="kw">true</span>)<span class="op">;</span></span></code></pre></div>
<p> </p>
<p>The intertidal area is than the area that is submerged during high tide (hitide2 = 1), but not submerged during low tide (lotide 2 = 0). Using this Boolean logic, combine both water classifications and subsequently mask out all pixels that are not part of the intertidal area:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb19-1"><a href="quality-mosaicking.html#cb19-1"></a><span class="co">// combine with boolean logic to get intertidal area, and mask everything but intertidal</span></span>
<span id="cb19-2"><a href="quality-mosaicking.html#cb19-2"></a><span class="kw">var</span> intertidal <span class="op">=</span> lotide2<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(hitide2<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb19-3"><a href="quality-mosaicking.html#cb19-3"></a><span class="kw">var</span> intertidal <span class="op">=</span> intertidal<span class="op">.</span><span class="fu">updateMask</span>(intertidal)<span class="op">;</span></span>
<span id="cb19-4"><a href="quality-mosaicking.html#cb19-4"></a> </span>
<span id="cb19-5"><a href="quality-mosaicking.html#cb19-5"></a><span class="co">// add to map</span></span>
<span id="cb19-6"><a href="quality-mosaicking.html#cb19-6"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(intertidal<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Intertidal area&#39;</span><span class="op">,</span><span class="kw">true</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span></code></pre></div>
<p> </p>
<p>To get a simple proxy for the time that the intertidal beds are submerged during each tide you can use the NDWI value of the mean Landsat composite (average situation):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb20-1"><a href="quality-mosaicking.html#cb20-1"></a><span class="co">// use masked mean NDWI of the entire collection to get a proxy for</span></span>
<span id="cb20-2"><a href="quality-mosaicking.html#cb20-2"></a><span class="co">//the time the intertidal beds are submerged</span></span>
<span id="cb20-3"><a href="quality-mosaicking.html#cb20-3"></a><span class="kw">var</span> subtime <span class="op">=</span> meanwat<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;index&#39;</span>)<span class="op">.</span><span class="fu">updateMask</span>(intertidal)<span class="op">;</span></span>
<span id="cb20-4"><a href="quality-mosaicking.html#cb20-4"></a><span class="kw">var</span> vis_params <span class="op">=</span> {<span class="dt">min</span><span class="op">:-</span><span class="fl">0.1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.4</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;yellow&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb20-5"><a href="quality-mosaicking.html#cb20-5"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(subtime<span class="op">,</span> vis_params<span class="op">,</span> <span class="st">&#39;Submerged time&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span></code></pre></div>
<p> 
 </p>
<p>The code works well, with some limitations, for the Western Scheldt estuary. However, Earth Engine allows and advertises with ‘planetary scale analysis’. Visit some other places to see if the code is transferable and scalable (tip: use the search bar as if you were in google maps). For example, check out the Wadden Sea or St. Malo.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="image-classification.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="regression.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
